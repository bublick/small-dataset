
{{$top_rated_rums := sort .rums "ratingsMedian" "desc" }}
{{$available_rums := dict }}

{{$all_rums := partialCached "cached_rums_with_db_id.html" .}}

{{ range $rumIndex, $rum := $top_rated_rums }}
    {{$rxid := $rum.rxid}}
    {{ with $map := index site.Data.shop_items_by_rx $rxid }}
        {{$singleRum := dict "rxid" $rxid "rumFilename" $rum.rumFilename "title" $rum  }}
        {{$available_rums = merge $available_rums (dict (string (len $available_rums)) $singleRum)}}
    {{end}}
{{ end }}

{{ if gt (len $top_rated_rums) 0 }}
<hr class="hr mt-5" />
<div class="detail-margin">
    <h2>{{ .heading }}</h2>

    {{ if gt (len $available_rums) 0 }}
    <div class="form-check form-switch mb-2">
        <input class="form-check-input" type="checkbox" role="switch" id="top-rums-switch">
        <label class="form-check-label" for="top-rums-switch">Only available rums</label>
    </div>
    {{ end }}

    <div class="row" id="row-top-rums-all">
        {{ range $index, $rum := $top_rated_rums }}
            {{ if lt $index site.Params.rumx.top_rums_count }}
                {{ range $rum_from_all := $all_rums }}
                    {{ if eq $rum.rxid $rum_from_all.rxid }}
                        {{partial "rum_item_from_dict.html" (dict "rum" $rum_from_all "show_top_comment" true) }}
                        {{break}}
                    {{ end }}
                {{ end }}
            {{ end }}
        {{end}}
        {{ partialCached "download.html" . }}
    </div>

    <div class="row" id="row-top-rums-available">
        {{ range $index, $rum := $available_rums }}
            {{ if lt $index site.Params.rumx.top_rums_count }}
                {{ $rumPage := site.GetPage (printf "/rums/%s" $rum.rumFilename) }}

                {{ with $rumPage}}
                    {{partial "rum_item.html" (dict "rum" . "show_top_comment" true) }}
                {{ end}}
            {{ end }}
        {{end}}
        {{ partialCached "download.html" . }}
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
    $("#top-rums-switch").on('change', function () {
        if ($(this).is(':checked')) {
            $("#row-top-rums-all").hide();
            $("#row-top-rums-available").show();
        }
        else {
            $("#row-top-rums-all").show();
            $("#row-top-rums-available").hide();
        }
    });

    $("#row-top-rums-available").hide();
</script>

{{ end }}